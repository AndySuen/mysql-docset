<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>15.6.3.4 Undo Tablespaces</title><link rel="stylesheet" type="text/css" href="mvl-otn.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="performance-schema" title="MySQL 8.0 Reference Manual" /><link rel="up" href="innodb-tablespace.html" title="15.6.3 Tablespaces" /><link rel="prev" href="general-tablespaces.html" title="15.6.3.3 General Tablespaces" /><link rel="next" href="innodb-temporary-tablespace.html" title="15.6.3.5 Temporary Tablespaces" /><script>window.ohcglobal || document.write('<script src="../../../en/dcommon/js/global.js">\x3C/script>')</script></head><body><div class="skip-link"><a href="innodb-undo-tablespaces.html#innodb-undo-tablespaces">Skip to Main Content</a></div><div class="DocTitle"><p>MySQL 8.0 Reference Manual Including MySQL NDB Cluster 8.0</p></div><div class="navigation"><ul><li class="navLinkPrevious"><a accesskey="p" title="Go To Previous Page [access key: p]" href="general-tablespaces.html">Previous <span class="navHint"> General Tablespaces </span></a></li><li class="navLinkHome"><a accesskey="h" title="Go To Home Page [access key: h]" href="performance-schema">Home <span class="navHint"> MySQL 8.0 Reference Manual Including MySQL NDB Cluster 8.0 </span></a></li><li class="navLinkUp"><a accesskey="u" title="Go Up A Level In The Navigation [access key: u]" href="innodb-tablespace.html">Up <span class="navHint"> Tablespaces </span></a></li><li class="navLinkNext"><a accesskey="n" title="Go To Next Page [access key: n]" href="innodb-temporary-tablespace.html">Next <span class="navHint"> Temporary Tablespaces </span></a></li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="innodb-undo-tablespaces"></a>15.6.3.4 Undo Tablespaces</h4></div></div></div><a id="idm45828890505808" class="indexterm"></a><a id="idm45828890504736" class="indexterm"></a><a id="idm45828890503664" class="indexterm"></a><p>
      Undo tablespaces contain undo logs, which are collections of
      records containing information about how to undo the latest change
      by a transaction to a clustered index record.
    </p><p>
      Undo tablespaces are described under the following topics in this
      section:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="xref" href="innodb-undo-tablespaces.html#innodb-default-undo-tablespaces" title="Default Undo Tablespaces">Default Undo Tablespaces</a></p></li><li class="listitem"><p><a class="xref" href="innodb-undo-tablespaces.html#innodb--undo-tablespace-size" title="Undo Tablespace Size">Undo Tablespace Size</a></p></li><li class="listitem"><p><a class="xref" href="innodb-undo-tablespaces.html#innodb-add-undo-tablespaces" title="Adding Undo Tablespaces">Adding Undo Tablespaces</a></p></li><li class="listitem"><p><a class="xref" href="innodb-undo-tablespaces.html#innodb-drop-undo-tablespaces" title="Dropping Undo Tablespaces">Dropping Undo Tablespaces</a></p></li><li class="listitem"><p><a class="xref" href="innodb-undo-tablespaces.html#innodb-move-undo-tablespaces" title="Moving Undo Tablespaces">Moving Undo Tablespaces</a></p></li><li class="listitem"><p><a class="xref" href="innodb-undo-tablespaces.html#innodb-undo-tablespace-rollback-segments" title="Configuring the Number of Rollback Segments">Configuring the Number of Rollback Segments</a></p></li><li class="listitem"><p><a class="xref" href="innodb-undo-tablespaces.html#truncate-undo-tablespace" title="Truncating Undo Tablespaces">Truncating Undo Tablespaces</a></p></li><li class="listitem"><p><a class="xref" href="innodb-undo-tablespaces.html#innodb-undo-tablespace-status-variables" title="Undo Tablespace Status Variables">Undo Tablespace Status Variables</a></p></li></ul></div><div class="simplesect"><div class="titlepage"><div><div><h5 class="title"><a id="innodb-default-undo-tablespaces"></a>Default Undo Tablespaces</h5></div></div></div><p>
        Two default undo tablespaces are created when the MySQL instance
        is initialized. Default undo tablespaces are created at
        initialization time to provide a location for rollback segments
        that must exist before SQL statements can be accepted. A minimum
        of two undo tablespaces is required to support automated
        truncation of undo tablespaces. See
        <a class="xref" href="innodb-undo-tablespaces.html#truncate-undo-tablespace" title="Truncating Undo Tablespaces">Truncating Undo Tablespaces</a>.
      </p><p>
        Default undo tablespaces are created in the location defined by
        the <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_directory"><code class="literal">innodb_undo_directory</code></a>
        variable. If the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_directory"><code class="literal">innodb_undo_directory</code></a> variable
        is undefined, default undo tablespaces are created in the data
        directory. Default undo tablespace data files are named
        <code class="filename">undo_001</code> and <code class="filename">undo_002</code>.
        The corresponding undo tablespace names defined in the data
        dictionary are <code class="literal">innodb_undo_001</code> and
        <code class="literal">innodb_undo_002</code>.
      </p><p>
        As of MySQL 8.0.14, additional undo tablespaces can be created
        at runtime using SQL. See
        <a class="xref" href="innodb-undo-tablespaces.html#innodb-add-undo-tablespaces" title="Adding Undo Tablespaces">Adding Undo Tablespaces</a>.
      </p></div><div class="simplesect"><div class="titlepage"><div><div><h5 class="title"><a id="innodb--undo-tablespace-size"></a>Undo Tablespace Size</h5></div></div></div><p>
        Prior to MySQL 8.0.23, the initial size of an undo tablespace
        depends on the <a class="link" href="innodb-parameters.html#sysvar_innodb_page_size"><code class="literal">innodb_page_size</code></a>
        value. For the default 16KB page size, the initial undo
        tablespace file size is 10MiB. For 4KB, 8KB, 32KB, and 64KB page
        sizes, the initial undo tablespace files sizes are 7MiB, 8MiB,
        20MiB, and 40MiB, respectively. As of MySQL 8.0.23, the initial
        undo tablespace size is normally 16MiB. The initial size may
        differ when a new undo tablespace is created by a truncate
        operation. In this case, if the file extension size is larger
        than 16MB, and the previous file extension occurred within the
        last second, the new undo tablespace is created at a quarter of
        the size defined by the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_max_undo_log_size"><code class="literal">innodb_max_undo_log_size</code></a>
        variable.
      </p><p>
        Prior to MySQL 8.0.23, an undo tablespace is extended four
        extents at a time. From MySQL 8.0.23, an undo tablespace is
        extended by a minimum of 16MB. To handle aggressive growth, the
        file extension size is doubled if the previous file extension
        happened less than 0.1 seconds earlier. Doubling of the
        extension size can occur multiple times to a maximum of 256MB.
        If the previous file extension occurred more than 0.1 seconds
        earlier, the extension size is reduced by half, which can also
        occur multiple times, to a minimum of 16MB. If the
        <code class="literal">AUTOEXTEND_SIZE</code> option is defined for an undo
        tablespace, it is extended by the greater of the
        <code class="literal">AUTOEXTEND_SIZE</code> setting and the extension
        size determined by the logic described above. For information
        about the <code class="literal">AUTOEXTEND_SIZE</code> option, see
        <a class="xref" href="innodb-tablespace-autoextend-size.html" title="15.6.3.9 Tablespace AUTOEXTEND_SIZE Configuration">Section 15.6.3.9, “Tablespace AUTOEXTEND_SIZE Configuration”</a>.
      </p></div><div class="simplesect"><div class="titlepage"><div><div><h5 class="title"><a id="innodb-add-undo-tablespaces"></a>Adding Undo Tablespaces</h5></div></div></div><p>
        Because undo logs can become large during long-running
        transactions, creating additional undo tablespaces can help
        prevent individual undo tablespaces from becoming too large. As
        of MySQL 8.0.14, additional undo tablespaces can be created at
        runtime using
        <a class="link" href="create-tablespace.html" title="13.1.21 CREATE TABLESPACE Statement"><code class="literal">CREATE UNDO
        TABLESPACE</code></a> syntax.
      </p><pre class="programlisting">CREATE UNDO TABLESPACE <em class="replaceable"><code>tablespace_name</code></em> ADD DATAFILE '<em class="replaceable"><code>file_name</code></em>.ibu';
</pre><p>
        The undo tablespace file name must have an
        <code class="filename">.ibu</code> extension. It is not permitted to
        specify a relative path when defining the undo tablespace file
        name. A fully qualified path is permitted, but the path must be
        known to <code class="literal">InnoDB</code>. Known paths are those
        defined by the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_directories"><code class="literal">innodb_directories</code></a> variable.
        Unique undo tablespace file names are recommended to avoid
        potential file name conflicts when moving or cloning data.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">Note</div><p>
          In a replication environment, the source and each replica must
          have its own undo tablespace file directory. Replicating the
          creation of an undo tablespace file to a common directory
          would cause a file name conflict.
        </p></div><p>
        At startup, directories defined by the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_directories"><code class="literal">innodb_directories</code></a> variable are
        scanned for undo tablespace files. (The scan also traverses
        subdirectories.) Directories defined by the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_data_home_dir"><code class="literal">innodb_data_home_dir</code></a>,
        <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_directory"><code class="literal">innodb_undo_directory</code></a>, and
        <a class="link" href="server-system-variables.html#sysvar_datadir"><code class="literal">datadir</code></a> variables are
        automatically appended to the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_directories"><code class="literal">innodb_directories</code></a> value
        regardless of whether the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_directories"><code class="literal">innodb_directories</code></a> variable is
        defined explicitly. An undo tablespace can therefore reside in
        paths defined by any of those variables.
      </p><p>
        If the undo tablespace file name does not include a path, the
        undo tablespace is created in the directory defined by the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_directory"><code class="literal">innodb_undo_directory</code></a> variable.
        If that variable is undefined, the undo tablespace is created in
        the data directory.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">Note</div><p>
          The <code class="literal">InnoDB</code> recovery process requires that
          undo tablespace files reside in known directories. Undo
          tablespace files must be discovered and opened before redo
          recovery and before other data files are opened to permit
          uncommitted transactions and data dictionary changes to be
          rolled back. An undo tablespace not found before recovery
          cannot be used, which can lead to database inconsistencies. An
          error message is reported at startup if an undo tablespace
          known to the data dictionary is not found. The known directory
          requirement also supports undo tablespace portability. See
          <a class="xref" href="innodb-undo-tablespaces.html#innodb-move-undo-tablespaces" title="Moving Undo Tablespaces">Moving Undo Tablespaces</a>.
        </p></div><p>
        To create undo tablespaces in a path relative to the data
        directory, set the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_directory"><code class="literal">innodb_undo_directory</code></a> variable
        to the relative path, and specify the file name only when
        creating an undo tablespace.
      </p><p>
        To view undo tablespace names and paths, query
        <a class="link" href="information-schema-files-table.html" title="26.3.15 The INFORMATION_SCHEMA FILES Table"><code class="literal">INFORMATION_SCHEMA.FILES</code></a>:
      </p><pre class="programlisting">SELECT TABLESPACE_NAME, FILE_NAME FROM INFORMATION_SCHEMA.FILES
  WHERE FILE_TYPE LIKE 'UNDO LOG';
</pre><p>
        A MySQL instance supports up to 127 undo tablespaces including
        the two default undo tablespaces created when the MySQL instance
        is initialized.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">Note</div><p>
          Prior to MySQL 8.0.14, additional undo tablespaces are created
          by configuring the
          <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_tablespaces"><code class="literal">innodb_undo_tablespaces</code></a>
          startup variable. This variable is deprecated and no longer
          configurable as of MySQL 8.0.14.
        </p><p>
          Prior to MySQL 8.0.14, increasing the
          <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_tablespaces"><code class="literal">innodb_undo_tablespaces</code></a>
          setting creates the specified number of undo tablespaces and
          adds them to the list of active undo tablespaces. Decreasing
          the <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_tablespaces"><code class="literal">innodb_undo_tablespaces</code></a>
          setting removes undo tablespaces from the list of active undo
          tablespaces. Undo tablespaces that are removed from the active
          list remain active until they are no longer used by existing
          transactions. The
          <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_tablespaces"><code class="literal">innodb_undo_tablespaces</code></a>
          variable can be configured at runtime using a
          <a class="link" href="set-statement.html" title="13.7.6 SET Statements"><code class="literal">SET</code></a>
          statement or defined in a configuration file.
        </p><p>
          Prior to MySQL 8.0.14, deactivated undo tablespaces cannot be
          removed. Manual removal of undo tablespace files is possible
          after a slow shutdown but is not recommended, as deactivated
          undo tablespaces may contain active undo logs for some time
          after the server is restarted if open transactions were
          present when shutting down the server. As of MySQL 8.0.14,
          undo tablespaces can be dropped using
          <a class="link" href="alter-tablespace.html" title="13.1.10 ALTER TABLESPACE Statement"><code class="literal">DROP UNDO
          TABALESPACE</code></a> syntax. See
          <a class="xref" href="innodb-undo-tablespaces.html#innodb-drop-undo-tablespaces" title="Dropping Undo Tablespaces">Dropping Undo Tablespaces</a>.
        </p></div></div><div class="simplesect"><div class="titlepage"><div><div><h5 class="title"><a id="innodb-drop-undo-tablespaces"></a>Dropping Undo Tablespaces</h5></div></div></div><p>
        As of MySQL 8.0.14, undo tablespaces created using
        <a class="link" href="create-tablespace.html" title="13.1.21 CREATE TABLESPACE Statement"><code class="literal">CREATE UNDO
        TABLESPACE</code></a> syntax can be dropped at runtime using
        <a class="link" href="alter-tablespace.html" title="13.1.10 ALTER TABLESPACE Statement"><code class="literal">DROP UNDO
        TABALESPACE</code></a> syntax.
      </p><p>
        An undo tablespace must be empty before it can be dropped. To
        empty an undo tablespace, the undo tablespace must first be
        marked as inactive using
        <a class="link" href="alter-tablespace.html" title="13.1.10 ALTER TABLESPACE Statement"><code class="literal">ALTER UNDO
        TABLESPACE</code></a> syntax so that the tablespace is no longer
        used for assigning rollback segments to new transactions.
      </p><pre class="programlisting">ALTER UNDO TABLESPACE <em class="replaceable"><code>tablespace_name</code></em> SET INACTIVE;
</pre><p>
        After an undo tablespace is marked as inactive, transactions
        currently using rollback segments in the undo tablespace are
        permitted to finish, as are any transactions started before
        those transactions are completed. After transactions are
        completed, the purge system frees the rollback segments in the
        undo tablespace, and the undo tablespace is truncated to its
        initial size. (The same process is used when truncating undo
        tablespaces. See <a class="xref" href="innodb-undo-tablespaces.html#truncate-undo-tablespace" title="Truncating Undo Tablespaces">Truncating Undo Tablespaces</a>.)
        Once the undo tablespace is empty, it can be dropped.
      </p><pre class="programlisting">DROP UNDO TABLESPACE <em class="replaceable"><code>tablespace_name</code></em>;
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">Note</div><p>
          Alternatively, the undo tablespace can be left in an empty
          state and reactivated later, if needed, by issuing an
          <a class="link" href="alter-tablespace.html" title="13.1.10 ALTER TABLESPACE Statement"><code class="literal">ALTER UNDO
          TABLESPACE <em class="replaceable"><code>tablespace_name</code></em> SET
          ACTIVE</code></a> statement.
        </p></div><p>
        The state of an undo tablespace can be monitored by querying the
        Information Schema
        <a class="link" href="information-schema-innodb-tablespaces-table.html" title="26.4.24 The INFORMATION_SCHEMA INNODB_TABLESPACES Table"><code class="literal">INNODB_TABLESPACES</code></a> table.
      </p><pre class="programlisting">SELECT NAME, STATE FROM INFORMATION_SCHEMA.INNODB_TABLESPACES
  WHERE NAME LIKE '<em class="replaceable"><code>tablespace_name</code></em>';
</pre><p>
        An <code class="literal">inactive</code> state indicates that rollback
        segments in an undo tablespace are no longer used by new
        transactions. An <code class="literal">empty</code> state indicates that
        an undo tablespace is empty and ready to be dropped, or ready to
        be made active again using an
        <a class="link" href="alter-tablespace.html" title="13.1.10 ALTER TABLESPACE Statement"><code class="literal">ALTER UNDO
        TABLESPACE <em class="replaceable"><code>tablespace_name</code></em> SET
        ACTIVE</code></a> statement. Attempting to drop an undo
        tablespace that is not empty returns an error.
      </p><p>
        The default undo tablespaces (<code class="literal">innodb_undo_001</code>
        and <code class="literal">innodb_undo_002</code>) created when the MySQL
        instance is initialized cannot be dropped. They can, however, be
        made inactive using an
        <a class="link" href="alter-tablespace.html" title="13.1.10 ALTER TABLESPACE Statement"><code class="literal">ALTER UNDO
        TABLESPACE <em class="replaceable"><code>tablespace_name</code></em> SET
        INACTIVE</code></a> statement. Before a default undo tablespace
        can be made inactive, there must be an undo tablespace to take
        its place. A minimum of two active undo tablespaces are required
        at all times to support automated truncation of undo
        tablespaces.
      </p></div><div class="simplesect"><div class="titlepage"><div><div><h5 class="title"><a id="innodb-move-undo-tablespaces"></a>Moving Undo Tablespaces</h5></div></div></div><p>
        Undo tablespaces created with
        <a class="link" href="create-tablespace.html" title="13.1.21 CREATE TABLESPACE Statement"><code class="literal">CREATE UNDO
        TABLESPACE</code></a> syntax can be moved while the server is
        offline to any known directory. Known directories are those
        defined by the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_directories"><code class="literal">innodb_directories</code></a> variable.
        Directories defined by
        <a class="link" href="innodb-parameters.html#sysvar_innodb_data_home_dir"><code class="literal">innodb_data_home_dir</code></a>,
        <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_directory"><code class="literal">innodb_undo_directory</code></a>, and
        <a class="link" href="server-system-variables.html#sysvar_datadir"><code class="literal">datadir</code></a> are automatically
        appended to the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_directories"><code class="literal">innodb_directories</code></a> value
        regardless of whether the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_directories"><code class="literal">innodb_directories</code></a> variable is
        defined explicitly. Those directories and their subdirectories
        are scanned at startup for undo tablespaces files. An undo
        tablespace file moved to any of those directories is discovered
        at startup and assumed to be the undo tablespace that was moved.
      </p><p>
        The default undo tablespaces (<code class="literal">innodb_undo_001</code>
        and <code class="literal">innodb_undo_002</code>) created when the MySQL
        instance is initialized must reside in the directory defined by
        the <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_directory"><code class="literal">innodb_undo_directory</code></a>
        variable. If the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_directory"><code class="literal">innodb_undo_directory</code></a> variable
        is undefined, default undo tablespaces reside in the data
        directory. If default undo tablespaces are moved while the
        server is offline, the server must be started with the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_directory"><code class="literal">innodb_undo_directory</code></a> variable
        configured to the new directory.
      </p><p>
        The I/O patterns for undo logs make undo tablespaces good
        candidates for <a class="link" href="glossary.html#glos_ssd" title="SSD">SSD</a> storage.
      </p></div><div class="simplesect"><div class="titlepage"><div><div><h5 class="title"><a id="innodb-undo-tablespace-rollback-segments"></a>Configuring the Number of Rollback Segments</h5></div></div></div><p>
        The <a class="link" href="innodb-parameters.html#sysvar_innodb_rollback_segments"><code class="literal">innodb_rollback_segments</code></a>
        variable defines the number of
        <a class="link" href="glossary.html#glos_rollback_segment" title="rollback segment">rollback segments</a>
        allocated to each undo tablespace and to the global temporary
        tablespace. The
        <a class="link" href="innodb-parameters.html#sysvar_innodb_rollback_segments"><code class="literal">innodb_rollback_segments</code></a>
        variable can be configured at startup or while the server is
        running.
      </p><p>
        The default setting for
        <a class="link" href="innodb-parameters.html#sysvar_innodb_rollback_segments"><code class="literal">innodb_rollback_segments</code></a> is
        128, which is also the maximum value. For information about the
        number of transactions that a rollback segment supports, see
        <a class="xref" href="innodb-undo-logs.html" title="15.6.6 Undo Logs">Section 15.6.6, “Undo Logs”</a>.
      </p></div><div class="simplesect"><div class="titlepage"><div><div><h5 class="title"><a id="truncate-undo-tablespace"></a>Truncating Undo Tablespaces</h5></div></div></div><a id="idm45828890382560" class="indexterm"></a><a id="idm45828890381488" class="indexterm"></a><a id="idm45828890380416" class="indexterm"></a><p>
        There are two methods of truncating undo tablespaces, which can
        be used individually or in combination to manage undo tablespace
        size. One method is automated, enabled using configuration
        variables. The other method is manual, performed using SQL
        statements.
      </p><p>
        The automated method does not require monitoring undo tablespace
        size and, once enabled, it performs deactivation, truncation,
        and reactivation of undo tablespaces without manual
        intervention. The manual truncation method may be preferable if
        you want to control when undo tablespaces are taken offline for
        truncation. For example, you may want to avoid truncating undo
        tablespaces during peak workload times.
      </p><h6><a id="idm45828890377760"></a>Automated Truncation</h6><p>
        Automated truncation of undo tablespaces requires a minimum of
        two active undo tablespaces, which ensures that one undo
        tablespace remains active while the other is taken offline to be
        truncated. By default, two undo tablespaces are created when the
        MySQL instance is initialized.
      </p><p>
        To have undo tablespaces automatically truncated, enable the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_log_truncate"><code class="literal">innodb_undo_log_truncate</code></a>
        variable. For example:
      </p><pre class="programlisting">mysql&gt; <strong class="userinput"><code>SET GLOBAL innodb_undo_log_truncate=ON;</code></strong>
</pre><p>
        When the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_log_truncate"><code class="literal">innodb_undo_log_truncate</code></a>
        variable is enabled, undo tablespaces that exceed the size limit
        defined by the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_max_undo_log_size"><code class="literal">innodb_max_undo_log_size</code></a>
        variable are subject to truncation. The
        <a class="link" href="innodb-parameters.html#sysvar_innodb_max_undo_log_size"><code class="literal">innodb_max_undo_log_size</code></a>
        variable is dynamic and has a default value of 1073741824 bytes
        (1024 MiB).
      </p><pre class="programlisting">mysql&gt; <strong class="userinput"><code>SELECT @@innodb_max_undo_log_size;</code></strong>
+----------------------------+
| @@innodb_max_undo_log_size |
+----------------------------+
|                 1073741824 |
+----------------------------+
</pre><p>
        When the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_log_truncate"><code class="literal">innodb_undo_log_truncate</code></a>
        variable is enabled:
      </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
            Default and user-defined undo tablespaces that exceed the
            <a class="link" href="innodb-parameters.html#sysvar_innodb_max_undo_log_size"><code class="literal">innodb_max_undo_log_size</code></a>
            setting are marked for truncation. Selection of an undo
            tablespace for truncation is performed in a circular fashion
            to avoid truncating the same undo tablespace each time.
          </p></li><li class="listitem"><p>
            Rollback segments residing in the selected undo tablespace
            are made inactive so that they are not assigned to new
            transactions. Existing transactions that are currently using
            rollback segments are permitted to finish.
          </p></li><li class="listitem"><p>
            The <a class="link" href="glossary.html#glos_purge" title="purge">purge</a> system empties
            rollback segments by freeing undo logs that are no longer in
            use.
          </p></li><li class="listitem"><p>
            After all rollback segments in the undo tablespace are
            freed, the truncate operation runs and truncates the undo
            tablespace to its initial size.
          </p><p>
            The size of an undo tablespace after a truncate operation
            may be larger than the initial size due to immediate use
            following the completion of the operation.
          </p><p>
            The <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_directory"><code class="literal">innodb_undo_directory</code></a>
            variable defines the location of default undo tablespace
            files. If the
            <a class="link" href="innodb-parameters.html#sysvar_innodb_undo_directory"><code class="literal">innodb_undo_directory</code></a>
            variable is undefined, default undo tablespaces reside in
            the data directory. The location of all undo tablespace
            files including user-defined undo tablespaces created using
            <a class="link" href="create-tablespace.html" title="13.1.21 CREATE TABLESPACE Statement"><code class="literal">CREATE
            UNDO TABLESPACE</code></a> syntax can be determined by
            querying the Information Schema
            <a class="link" href="information-schema-files-table.html" title="26.3.15 The INFORMATION_SCHEMA FILES Table"><code class="literal">FILES</code></a> table:
          </p><pre class="programlisting">SELECT TABLESPACE_NAME, FILE_NAME FROM INFORMATION_SCHEMA.FILES WHERE FILE_TYPE LIKE 'UNDO LOG';</pre></li><li class="listitem"><p>
            Rollback segments are reactivated so that they can be
            assigned to new transactions.
          </p></li></ol></div><h6><a id="idm45828890349360"></a>Manual Truncation</h6><p>
        Manual truncation of undo tablespaces requires a minimum of
        three active undo tablespaces. Two active undo tablespaces are
        required at all times to support the possibility that automated
        truncation is enabled. A minimum of three undo tablespaces
        satisfies this requirement while permitting an undo tablespace
        to be taken offline manually.
      </p><p>
        To manually initiate truncation of an undo tablespace,
        deactivate the undo tablespace by issuing the following
        statement:
      </p><pre class="programlisting">ALTER UNDO TABLESPACE <em class="replaceable"><code>tablespace_name</code></em> SET INACTIVE;
</pre><p>
        After the undo tablespace is marked as inactive, transactions
        currently using rollback segments in the undo tablespace are
        permitted to finish, as are any transactions started before
        those transactions are completed. After transactions are
        completed, the purge system frees the rollback segments in the
        undo tablespace, the undo tablespace is truncated to its initial
        size, and the undo tablespace state changes from
        <code class="literal">inactive</code> to <code class="literal">empty</code>.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">Note</div><p>
          When an <code class="literal">ALTER UNDO TABLESPACE
          <em class="replaceable"><code>tablespace_name</code></em> SET
          INACTIVE</code> statement deactivates an undo tablespace,
          the purge thread looks for that undo tablespace at the next
          opportunity. Once the undo tablespace is found and marked for
          truncation, the purge thread returns with increased frequency
          to quickly empty and truncate the undo tablespace.
        </p></div><p>
        To check the state of an undo tablespace, query the Information
        Schema <a class="link" href="information-schema-innodb-tablespaces-table.html" title="26.4.24 The INFORMATION_SCHEMA INNODB_TABLESPACES Table"><code class="literal">INNODB_TABLESPACES</code></a> table.
      </p><pre class="programlisting">SELECT NAME, STATE FROM INFORMATION_SCHEMA.INNODB_TABLESPACES
  WHERE NAME LIKE '<em class="replaceable"><code>tablespace_name</code></em>';
</pre><p>
        Once the undo tablespace is in an <code class="literal">empty</code>
        state, it can be reactivated by issuing the following statement:
      </p><pre class="programlisting">ALTER UNDO TABLESPACE <em class="replaceable"><code>tablespace_name</code></em> SET ACTIVE;
</pre><p>
        An undo tablespace in an <code class="literal">empty</code> state can also
        be dropped. See <a class="xref" href="innodb-undo-tablespaces.html#innodb-drop-undo-tablespaces" title="Dropping Undo Tablespaces">Dropping Undo Tablespaces</a>.
      </p><h6><a id="idm45828890333248"></a>Expediting Automated Truncation of Undo Tablespaces</h6><p>
        The purge thread is responsible for emptying and truncating undo
        tablespaces. By default, the purge thread looks for undo
        tablespaces to truncate once every 128 times that purge is
        invoked. The frequency with which the purge thread looks for
        undo tablespaces to truncate is controlled by the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_purge_rseg_truncate_frequency"><code class="literal">innodb_purge_rseg_truncate_frequency</code></a>
        variable, which has a default setting of 128.
      </p><pre class="programlisting">mysql&gt; <strong class="userinput"><code>SELECT @@innodb_purge_rseg_truncate_frequency;</code></strong>
+----------------------------------------+
| @@innodb_purge_rseg_truncate_frequency |
+----------------------------------------+
|                                    128 |
+----------------------------------------+
</pre><p>
        To increase the frequency, decrease the
        <a class="link" href="innodb-parameters.html#sysvar_innodb_purge_rseg_truncate_frequency"><code class="literal">innodb_purge_rseg_truncate_frequency</code></a>
        setting. For example, to have the purge thread look for undo
        tablespaces once every 32 times that purge is invoked, set
        <a class="link" href="innodb-parameters.html#sysvar_innodb_purge_rseg_truncate_frequency"><code class="literal">innodb_purge_rseg_truncate_frequency</code></a>
        to 32.
      </p><pre class="programlisting">mysql&gt; <strong class="userinput"><code>SET GLOBAL innodb_purge_rseg_truncate_frequency=32;</code></strong>
</pre><h6><a id="idm45828890323696"></a>Performance Impact of Truncating Undo Tablespace Files</h6><p>
        When an undo tablespace is truncated, the rollback segments in
        the undo tablespace are deactivated. The active rollback
        segments in other undo tablespaces assume responsibility for the
        entire system load, which may result in a slight performance
        degradation. The extent to which performance is affected depends
        on a number of factors:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Number of undo tablespaces
          </p></li><li class="listitem"><p>
            Number of undo logs
          </p></li><li class="listitem"><p>
            Undo tablespace size
          </p></li><li class="listitem"><p>
            Speed of the I/O subsystem
          </p></li><li class="listitem"><p>
            Existing long running transactions
          </p></li><li class="listitem"><p>
            System load
          </p></li></ul></div><p>
        The easiest way to avoid the potential performance impact is to
        increase the number of undo tablespaces.
      </p><h6><a id="idm45828890316256"></a>Monitoring Undo Tablespace Truncation</h6><p>
        As of MySQL 8.0.16, <code class="literal">undo</code> and
        <code class="literal">purge</code> subsystem counters are provided for
        monitoring background activities associated with undo log
        truncation. For counter names and descriptions, query the
        Information Schema <a class="link" href="information-schema-innodb-metrics-table.html" title="26.4.21 The INFORMATION_SCHEMA INNODB_METRICS Table"><code class="literal">INNODB_METRICS</code></a>
        table.
      </p><pre class="programlisting">SELECT NAME, SUBSYSTEM, COMMENT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME LIKE '%truncate%';
</pre><p>
        For information about enabling counters and querying counter
        data, see
        <a class="xref" href="innodb-information-schema-metrics-table.html" title="15.15.6 InnoDB INFORMATION_SCHEMA Metrics Table">Section 15.15.6, “InnoDB INFORMATION_SCHEMA Metrics Table”</a>.
      </p><h6><a id="idm45828890309968"></a>Undo Tablespace Truncation Limit</h6><p>
        As of MySQL 8.0.21, the number of truncate operations on the
        same undo tablespace between checkpoints is limited to 64. The
        limit prevents potential issues caused by an excessive number of
        undo tablespace truncate operations, which can occur if
        <a class="link" href="innodb-parameters.html#sysvar_innodb_max_undo_log_size"><code class="literal">innodb_max_undo_log_size</code></a> is set
        too low on a busy system, for example. If the limit is exceeded,
        an undo tablespace can still be made inactive, but it is not
        truncated until after the next checkpoint. the limit was raised
        from 64 to 50,000 in MySQL 8.0.22.
      </p><h6><a id="idm45828890307072"></a>Undo Tablespace Truncation Recovery</h6><p>
        An undo tablespace truncate operation creates a temporary
        <code class="filename">undo_<em class="replaceable"><code>space_number</code></em>_trunc.log</code>
        file in the server log directory. That log directory is defined
        by <a class="link" href="innodb-parameters.html#sysvar_innodb_log_group_home_dir"><code class="literal">innodb_log_group_home_dir</code></a>.
        If a system failure occurs during the truncate operation, the
        temporary log file permits the startup process to identify undo
        tablespaces that were being truncated and to continue the
        operation.
      </p></div><div class="simplesect"><div class="titlepage"><div><div><h5 class="title"><a id="innodb-undo-tablespace-status-variables"></a>Undo Tablespace Status Variables</h5></div></div></div><p>
        The following status variables permit tracking the total number
        of undo tablespaces, implicit
        (<code class="literal">InnoDB</code>-created) undo tablespaces, explicit
        (user-created) undo tablespaces, and the number of active undo
        tablespaces:
      </p><pre class="programlisting">mysql&gt; <strong class="userinput"><code>SHOW STATUS LIKE 'Innodb_undo_tablespaces%';</code></strong>
+----------------------------------+-------+
| Variable_name                    | Value |
+----------------------------------+-------+
| Innodb_undo_tablespaces_total    | 2     |
| Innodb_undo_tablespaces_implicit | 2     |
| Innodb_undo_tablespaces_explicit | 0     |
| Innodb_undo_tablespaces_active   | 2     |
+----------------------------------+-------+
</pre><p>
        For status variable descriptions, see
        <a class="xref" href="server-status-variables.html" title="5.1.10 Server Status Variables">Section 5.1.10, “Server Status Variables”</a>.
      </p></div></div><div class="navigation"><ul><li class="navLinkPrevious"><a title="Go To Previous Page" href="general-tablespaces.html">Previous <span class="navHint"> General Tablespaces </span></a></li><li class="navLinkHome"><a title="Go To Home Page" href="performance-schema">Home <span class="navHint"> MySQL 8.0 Reference Manual Including MySQL NDB Cluster 8.0 </span></a></li><li class="navLinkUp"><a title="Go Up A Level In The Navigation" href="innodb-tablespace.html">Up <span class="navHint"> Tablespaces </span></a></li><li class="navLinkNext"><a title="Go To Next Page" href="innodb-temporary-tablespace.html">Next <span class="navHint"> Temporary Tablespaces </span></a></li></ul></div><div class="dochomelink-footer"><a title="Go to MySQL Doc Library" href="https://docs.oracle.com/cd/E17952_01/index.html">
        MySQL Documentation Library
      </a></div><div class="copyright-footer"></div></body></html>